# 物联网生鲜品储运系统 - 数据库设计说明

## 数据库概览

本系统使用MySQL 8.0作为主要数据存储，采用关系型数据库设计，确保数据的一致性和完整性。数据库设计遵循规范化原则，同时兼顾查询性能。

## 数据库表结构

### 1. 用户表 (users)

#### 表结构
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码',
    real_name VARCHAR(100) COMMENT '真实姓名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '电话',
    department VARCHAR(50) COMMENT '部门',
    position VARCHAR(50) COMMENT '职位',
    avatar VARCHAR(255) COMMENT '头像URL',
    status TINYINT DEFAULT 1 COMMENT '用户状态：1-启用，0-禁用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 字段说明
- `id`: 主键，自增
- `username`: 用户名，唯一约束
- `password`: 加密后的密码
- `real_name`: 真实姓名
- `email`: 邮箱地址
- `phone`: 电话号码
- `department`: 所属部门
- `position`: 职位
- `avatar`: 头像URL
- `status`: 用户状态
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. 设备表 (devices)

#### 表结构
```sql
CREATE TABLE devices (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vid VARCHAR(50) UNIQUE NOT NULL COMMENT '设备唯一标识',
    device_name VARCHAR(100) NOT NULL COMMENT '设备名称',
    device_type VARCHAR(50) COMMENT '设备类型',
    location VARCHAR(255) COMMENT '设备位置',
    description TEXT COMMENT '设备描述',
    status TINYINT DEFAULT 1 COMMENT '设备状态：1-在线，0-离线，2-故障',
    manufacturer VARCHAR(100) COMMENT '制造商',
    model VARCHAR(100) COMMENT '型号',
    firmware_version VARCHAR(50) COMMENT '固件版本',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    mac_address VARCHAR(17) COMMENT 'MAC地址',
    last_online_time TIMESTAMP NULL COMMENT '最后在线时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_vid (vid),
    INDEX idx_status (status),
    INDEX idx_location (location(100))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='设备表';
```

#### 字段说明
- `id`: 主键，自增
- `vid`: 设备唯一标识符，唯一约束
- `device_name`: 设备名称
- `device_type`: 设备类型
- `location`: 设备物理位置
- `description`: 设备描述信息
- `status`: 设备状态
- `manufacturer`: 制造商
- `model`: 型号
- `firmware_version`: 固件版本
- `ip_address`: IP地址
- `mac_address`: MAC地址
- `last_online_time`: 最后在线时间
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 3. 设备数据表 (device_data)

#### 表结构
```sql
CREATE TABLE device_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    vid VARCHAR(50) NOT NULL COMMENT '设备唯一标识',
    tin DOUBLE COMMENT '内部温度',
    tout DOUBLE COMMENT '外部温度',
    hin INT COMMENT '内部湿度百分比',
    hout INT COMMENT '外部湿度百分比',
    lxin INT COMMENT '内部光照强度',
    lxout INT COMMENT '外部光照强度',
    brightness INT COMMENT '亮度',
    vstatus TINYINT COMMENT '设备状态：1-运行，0-停止',
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '数据时间戳',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_vid (vid),
    INDEX idx_timestamp (timestamp),
    INDEX idx_vid_timestamp (vid, timestamp),
    FOREIGN KEY (vid) REFERENCES devices(vid) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='设备数据表';
```

#### 字段说明
- `id`: 主键，自增
- `vid`: 设备唯一标识，外键关联devices表
- `tin`: 内部温度值
- `tout`: 外部温度值
- `hin`: 内部湿度百分比
- `hout`: 外部湿度百分比
- `lxin`: 内部光照强度
- `lxout`: 外部光照强度
- `brightness`: 亮度值
- `vstatus`: 设备运行状态
- `timestamp`: 数据采集时间戳
- `created_at`: 记录创建时间
- `updated_at`: 记录更新时间

### 4. 报警表 (alarms)

#### 表结构
```sql
CREATE TABLE alarms (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id BIGINT COMMENT '设备ID',
    vid VARCHAR(50) COMMENT '设备唯一标识',
    alarm_type VARCHAR(50) NOT NULL COMMENT '报警类型',
    alarm_level ENUM('low', 'medium', 'high', 'critical') DEFAULT 'medium' COMMENT '报警级别',
    title VARCHAR(200) NOT NULL COMMENT '报警标题',
    description TEXT COMMENT '报警描述',
    status ENUM('pending', 'acknowledged', 'resolved', 'ignored') DEFAULT 'pending' COMMENT '报警状态',
    trigger_value VARCHAR(100) COMMENT '触发值',
    threshold_value VARCHAR(100) COMMENT '阈值',
    resolved_by BIGINT COMMENT '解决者ID',
    resolved_at TIMESTAMP NULL COMMENT '解决时间',
    acknowledged_by BIGINT COMMENT '确认者ID',
    acknowledged_at TIMESTAMP NULL COMMENT '确认时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_device_id (device_id),
    INDEX idx_vid (vid),
    INDEX idx_alarm_type (alarm_type),
    INDEX idx_alarm_level (alarm_level),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE SET NULL,
    FOREIGN KEY (resolved_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (acknowledged_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='报警表';
```

#### 字段说明
- `id`: 主键，自增
- `device_id`: 关联的设备ID
- `vid`: 设备唯一标识
- `alarm_type`: 报警类型
- `alarm_level`: 报警级别（低、中、高、危急）
- `title`: 报警标题
- `description`: 报警详细描述
- `status`: 报警处理状态
- `trigger_value`: 触发报警的实际值
- `threshold_value`: 阈值
- `resolved_by`: 解决此报警的用户ID
- `resolved_at`: 报警解决时间
- `acknowledged_by`: 确认此报警的用户ID
- `acknowledged_at`: 报警确认时间
- `created_at`: 报警创建时间
- `updated_at`: 更新时间

## 数据库索引策略

### 1. 主要索引
- **主键索引**: 每个表都有主键索引，用于快速定位记录
- **唯一索引**: 用户名、设备VID等关键字段建立唯一索引
- **普通索引**: 经常用于查询条件的字段

### 2. 复合索引
- `(vid, timestamp)` - 用于设备数据按时间和设备查询
- `(status, created_at)` - 用于按状态和时间范围查询

### 3. 索引优化建议
- 对经常用于WHERE子句的字段建立索引
- 对JOIN操作涉及的外键建立索引
- 对ORDER BY和GROUP BY子句中的字段考虑建立索引

## 数据库约束

### 1. 外键约束
- `device_data.vid` → `devices.vid`
- `alarms.device_id` → `devices.id`
- `alarms.resolved_by` → `users.id`
- `alarms.acknowledged_by` → `users.id`

### 2. 唯一约束
- `users.username` - 用户名唯一
- `devices.vid` - 设备VID唯一

### 3. 检查约束
- `alarm_level` 使用ENUM限制值范围
- `status` 字段使用TINYINT或ENUM限制有效值

## 性能优化

### 1. 查询优化
- 使用适当的索引提高查询速度
- 避免SELECT *，明确指定所需字段
- 合理使用LIMIT进行分页查询

### 2. 表分区
- `device_data` 表可考虑按时间进行分区
- 减少单表数据量，提高查询效率

### 3. 数据归档
- 历史数据定期归档到归档表
- 减少主表数据量，提高查询性能

## 数据安全

### 1. 访问控制
- 数据库用户权限最小化原则
- 敏感数据访问日志记录

### 2. 数据加密
- 敏感字段如密码使用加密存储
- 传输过程中使用SSL/TLS加密

### 3. 备份策略
- 定期自动备份
- 多地备份存储
- 备份数据加密存储

## 扩展性考虑

### 1. 水平扩展
- 适当的数据分片策略
- 读写分离架构支持

### 2. 垂直扩展
- 合理的表结构设计
- 预留扩展字段

### 3. 缓存集成
- Redis缓存热点数据
- 减少数据库访问压力

## 维护建议

### 1. 定期维护
- 定期更新表统计信息
- 检查和优化索引使用情况
- 监控慢查询日志

### 2. 监控指标
- 数据库连接数
- 查询响应时间
- 磁盘空间使用率

### 3. 容量规划
- 定期评估数据增长趋势
- 提前规划硬件升级
- 考虑数据归档策略

## 总结

本数据库设计充分考虑了物联网系统的特性，包括大量设备数据的存储需求、实时性要求以及扩展性需求。通过合理的表结构设计、索引策略和约束设置，确保了数据的完整性、一致性和高性能访问。同时，设计中也考虑了安全性、可维护性和扩展性，为系统的长期稳定运行奠定了基础。