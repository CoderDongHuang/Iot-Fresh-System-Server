# IoTç³»ç»ŸçŸ­ä¿¡é€šçŸ¥åŠŸèƒ½ - åç«¯APIè®¾è®¡æ–‡æ¡£

## ğŸ“‹ APIæ¥å£è®¾è®¡

### 1. çŸ­ä¿¡è®¾ç½®ç®¡ç†

#### GET /api/sms/settings
**è·å–çŸ­ä¿¡è®¾ç½®**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "enabled": true,
    "phoneNumbers": ["13800138000", "13900139000"],
    "notifyLevels": ["high", "medium"],
    "quietHours": ["22:00", "07:00"],
    "pushFrequency": "immediate"
  }
}
```

#### POST /api/sms/settings
**ä¿å­˜çŸ­ä¿¡è®¾ç½®**
```json
{
  "enabled": true,
  "phoneNumbers": ["13800138000", "13900139000"],
  "notifyLevels": ["high", "medium"],
  "quietHours": ["22:00", "07:00"],
  "pushFrequency": "immediate"
}
```

### 2. çŸ­ä¿¡æ¨¡æ¿ç®¡ç†

#### GET /api/sms/templates
**è·å–çŸ­ä¿¡æ¨¡æ¿**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "high": "ã€IoTç³»ç»Ÿã€‘ç´§æ€¥æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œçº§åˆ«ï¼š{level}ï¼Œå†…å®¹ï¼š{content}",
    "medium": "ã€IoTç³»ç»Ÿã€‘é‡è¦æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œå†…å®¹ï¼š{content}",
    "low": "ã€IoTç³»ç»Ÿã€‘ä¸€èˆ¬æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œå†…å®¹ï¼š{content}"
  }
}
```

#### POST /api/sms/templates
**ä¿å­˜çŸ­ä¿¡æ¨¡æ¿**
```json
{
  "high": "ã€IoTç³»ç»Ÿã€‘ç´§æ€¥æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œçº§åˆ«ï¼š{level}ï¼Œå†…å®¹ï¼š{content}",
  "medium": "ã€IoTç³»ç»Ÿã€‘é‡è¦æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œå†…å®¹ï¼š{content}",
  "low": "ã€IoTç³»ç»Ÿã€‘ä¸€èˆ¬æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œå†…å®¹ï¼š{content}"
}
```

### 3. çŸ­ä¿¡å‘é€åŠŸèƒ½

#### POST /api/sms/send
**å‘é€çŸ­ä¿¡**
```json
{
  "phoneNumbers": ["13800138000"],
  "template": "ã€IoTç³»ç»Ÿã€‘ç´§æ€¥æŠ¥è­¦ï¼è®¾å¤‡ï¼š{device}ï¼Œçº§åˆ«ï¼š{level}ï¼Œå†…å®¹ï¼š{content}",
  "variables": {
    "device": "æ¸©åº¦ä¼ æ„Ÿå™¨001",
    "level": "é«˜ä¼˜å…ˆçº§",
    "content": "æ¸©åº¦è¶…è¿‡é˜ˆå€¼28Â°C"
  },
  "level": "high"
}
```

#### POST /api/sms/test
**æµ‹è¯•çŸ­ä¿¡å‘é€**
```json
{
  "phoneNumber": "13800138000"
}
```

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### çŸ­ä¿¡è®¾ç½®è¡¨ (sms_settings)
```sql
CREATE TABLE sms_settings (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  enabled BOOLEAN DEFAULT FALSE,
  phone_numbers JSON, -- ["13800138000", "13900139000"]
  notify_levels JSON, -- ["high", "medium"]
  quiet_hours JSON, -- ["22:00", "07:00"]
  push_frequency ENUM('immediate', 'batch', 'summary') DEFAULT 'immediate',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### çŸ­ä¿¡æ¨¡æ¿è¡¨ (sms_templates)
```sql
CREATE TABLE sms_templates (
  id INT PRIMARY KEY AUTO_INCREMENT,
  template_type ENUM('high', 'medium', 'low') NOT NULL,
  template_content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### çŸ­ä¿¡å‘é€è®°å½•è¡¨ (sms_logs)
```sql
CREATE TABLE sms_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  alarm_id INT,
  phone_number VARCHAR(20) NOT NULL,
  message_content TEXT NOT NULL,
  template_type ENUM('high', 'medium', 'low'),
  send_status ENUM('success', 'failed') NOT NULL,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ”§ çŸ­ä¿¡æœåŠ¡å•†é›†æˆ

### é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡é…ç½®
```java
@Component
public class AliyunSmsService {
    
    @Value("${sms.aliyun.access-key-id}")
    private String accessKeyId;
    
    @Value("${sms.aliyun.access-key-secret}")
    private String accessKeySecret;
    
    @Value("${sms.aliyun.sign-name}")
    private String signName;
    
    @Value("${sms.aliyun.template-code}")
    private String templateCode;
    
    public boolean sendSms(String phoneNumber, String templateParam) {
        try {
            DefaultProfile profile = DefaultProfile.getProfile("cn-hangzhou", accessKeyId, accessKeySecret);
            IAcsClient client = new DefaultAcsClient(profile);
            
            CommonRequest request = new CommonRequest();
            request.setSysMethod(MethodType.POST);
            request.setSysDomain("dysmsapi.aliyuncs.com");
            request.setSysVersion("2017-05-25");
            request.setSysAction("SendSms");
            request.putQueryParameter("RegionId", "cn-hangzhou");
            request.putQueryParameter("PhoneNumbers", phoneNumber);
            request.putQueryParameter("SignName", signName);
            request.putQueryParameter("TemplateCode", templateCode);
            request.putQueryParameter("TemplateParam", templateParam);
            
            CommonResponse response = client.getCommonResponse(request);
            return response.getHttpStatus() == 200;
        } catch (Exception e) {
            log.error("çŸ­ä¿¡å‘é€å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }
}
```

### è…¾è®¯äº‘çŸ­ä¿¡æœåŠ¡é…ç½®
```java
@Component
public class TencentSmsService {
    
    @Value("${sms.tencent.secret-id}")
    private String secretId;
    
    @Value("${sms.tencent.secret-key}")
    private String secretKey;
    
    @Value("${sms.tencent.app-id}")
    private String appId;
    
    @Value("${sms.tencent.sign-name}")
    private String signName;
    
    @Value("${sms.tencent.template-id}")
    private String templateId;
    
    public boolean sendSms(String phoneNumber, String[] templateParams) {
        try {
            Credential cred = new Credential(secretId, secretKey);
            SmsClient client = new SmsClient(cred, "ap-guangzhou");
            
            SendSmsRequest req = new SendSmsRequest();
            req.setSmsSdkAppId(appId);
            req.setSignName(signName);
            req.setTemplateId(templateId);
            req.setPhoneNumberSet(new String[]{phoneNumber});
            req.setTemplateParamSet(templateParams);
            
            SendSmsResponse resp = client.SendSms(req);
            return resp.getSendStatusSet()[0].getCode().equals("Ok");
        } catch (Exception e) {
            log.error("çŸ­ä¿¡å‘é€å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }
}
```

## ğŸ”„ ä¸šåŠ¡é€»è¾‘å®ç°

### 1. çŸ­ä¿¡å‘é€æœåŠ¡
```java
@Service
public class SmsNotificationService {
    
    @Autowired
    private SmsSettingsRepository smsSettingsRepository;
    
    @Autowired
    private SmsTemplatesRepository smsTemplatesRepository;
    
    @Autowired
    private SmsLogsRepository smsLogsRepository;
    
    @Autowired
    private AliyunSmsService aliyunSmsService;
    
    public void sendAlarmSms(Alarm alarm) {
        // 1. è·å–çŸ­ä¿¡è®¾ç½®
        SmsSettings settings = smsSettingsRepository.findByUserId(alarm.getUserId());
        if (settings == null || !settings.isEnabled()) {
            return;
        }
        
        // 2. æ£€æŸ¥æŠ¥è­¦çº§åˆ«
        if (!settings.getNotifyLevels().contains(alarm.getLevel())) {
            return;
        }
        
        // 3. æ£€æŸ¥å…æ‰“æ‰°æ—¶æ®µ
        if (isInQuietHours(settings.getQuietHours())) {
            return;
        }
        
        // 4. è·å–çŸ­ä¿¡æ¨¡æ¿
        String template = getSmsTemplate(alarm.getLevel());
        
        // 5. æ›¿æ¢æ¨¡æ¿å˜é‡
        String message = replaceTemplateVariables(template, alarm);
        
        // 6. å‘é€çŸ­ä¿¡
        for (String phoneNumber : settings.getPhoneNumbers()) {
            boolean success = aliyunSmsService.sendSms(phoneNumber, message);
            
            // 7. è®°å½•å‘é€æ—¥å¿—
            SmsLog smsLog = new SmsLog();
            smsLog.setAlarmId(alarm.getId());
            smsLog.setPhoneNumber(phoneNumber);
            smsLog.setMessageContent(message);
            smsLog.setTemplateType(alarm.getLevel());
            smsLog.setSendStatus(success ? "success" : "failed");
            smsLogsRepository.save(smsLog);
        }
    }
    
    private boolean isInQuietHours(String[] quietHours) {
        // å®ç°å…æ‰“æ‰°æ—¶æ®µæ£€æŸ¥é€»è¾‘
        return false;
    }
    
    private String getSmsTemplate(String level) {
        // è·å–å¯¹åº”çº§åˆ«çš„çŸ­ä¿¡æ¨¡æ¿
        return "";
    }
    
    private String replaceTemplateVariables(String template, Alarm alarm) {
        // æ›¿æ¢æ¨¡æ¿å˜é‡
        return template;
    }
}
```

### 2. æ§åˆ¶å™¨å®ç°
```java
@RestController
@RequestMapping("/api/sms")
public class SmsController {
    
    @Autowired
    private SmsSettingsService smsSettingsService;
    
    @Autowired
    private SmsTemplatesService smsTemplatesService;
    
    @Autowired
    private SmsNotificationService smsNotificationService;
    
    @GetMapping("/settings")
    public ResponseData<SmsSettings> getSettings() {
        // è·å–å½“å‰ç”¨æˆ·çš„çŸ­ä¿¡è®¾ç½®
        return ResponseData.success(smsSettingsService.getCurrentUserSettings());
    }
    
    @PostMapping("/settings")
    public ResponseData<Void> saveSettings(@RequestBody SmsSettings settings) {
        smsSettingsService.saveSettings(settings);
        return ResponseData.success();
    }
    
    @PostMapping("/send")
    public ResponseData<Void> sendSms(@RequestBody SendSmsRequest request) {
        smsNotificationService.sendCustomSms(request);
        return ResponseData.success();
    }
    
    @PostMapping("/test")
    public ResponseData<Void> testSms(@RequestBody TestSmsRequest request) {
        smsNotificationService.sendTestSms(request.getPhoneNumber());
        return ResponseData.success();
    }
}
```

## ğŸ”§ é…ç½®æ–‡ä»¶

### application.yml
```yaml
sms:
  provider: aliyun # aliyun æˆ– tencent
  aliyun:
    access-key-id: your-access-key-id
    access-key-secret: your-access-key-secret
    sign-name: IoTç³»ç»Ÿ
    template-code: SMS_123456789
  tencent:
    secret-id: your-secret-id
    secret-key: your-secret-key
    app-id: your-app-id
    sign-name: IoTç³»ç»Ÿ
    template-id: 123456
```

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### 1. å•å…ƒæµ‹è¯•
```java
@SpringBootTest
class SmsNotificationServiceTest {
    
    @Autowired
    private SmsNotificationService smsNotificationService;
    
    @Test
    void testSendAlarmSms() {
        Alarm alarm = new Alarm();
        alarm.setLevel("high");
        alarm.setDeviceName("æ¸©åº¦ä¼ æ„Ÿå™¨001");
        alarm.setAlarmContent("æ¸©åº¦è¶…è¿‡é˜ˆå€¼28Â°C");
        
        smsNotificationService.sendAlarmSms(alarm);
        
        // éªŒè¯çŸ­ä¿¡å‘é€è®°å½•
        List<SmsLog> logs = smsLogsRepository.findByAlarmId(alarm.getId());
        assertThat(logs).isNotEmpty();
    }
}
```

### 2. é›†æˆæµ‹è¯•
ä½¿ç”¨Postmanæµ‹è¯•APIæ¥å£ï¼š
- GET /api/sms/settings
- POST /api/sms/settings
- POST /api/sms/test

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### çŸ­ä¿¡å‘é€ç»Ÿè®¡
- æ¯æ—¥å‘é€é‡ç»Ÿè®¡
- æˆåŠŸç‡ç»Ÿè®¡
- å¤±è´¥åŸå› åˆ†æ
- è´¹ç”¨ç»Ÿè®¡

### æ—¥å¿—è®°å½•
```json
{
  "timestamp": "2024-01-23T10:30:00",
  "level": "INFO",
  "service": "SmsNotificationService",
  "message": "çŸ­ä¿¡å‘é€æˆåŠŸ",
  "phoneNumber": "13800138000",
  "alarmId": 123,
  "templateType": "high"
}
```

è¿™ä¸ªåç«¯è®¾è®¡æ–‡æ¡£æä¾›äº†å®Œæ•´çš„çŸ­ä¿¡é€šçŸ¥åŠŸèƒ½å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬APIè®¾è®¡ã€æ•°æ®åº“è®¾è®¡ã€æœåŠ¡é›†æˆå’Œä¸šåŠ¡é€»è¾‘å®ç°ã€‚