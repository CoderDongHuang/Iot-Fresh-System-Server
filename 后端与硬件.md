## 二、MQTT主题设计（后端↔硬件）

### 1. 数据上报主题（硬件→后端）

```
# 实时数据上报
device/{vid}/data
payload: {"Tin": 22.5, "Tout": 18.0, "LXin": 300, "pid": "PID001"}

# 报警上报
device/{vid}/alarm
payload: {"type": "temperature", "code": 1001, "message": "温度过高"}

# RFID读取上报
device/{vid}/rfid
payload: {"pid": "PID001", "time": 1620000000}

# 设备状态上报
device/{vid}/status
payload: {"VStatus": 0, "battery": 85}
```



### 2. 控制指令主题（后端→硬件）

```
# 温度控制
device/{vid}/control/temperature
payload: {"mode": "cooling", "speed": 1200}

# 光照控制
device/{vid}/control/light
payload: {"brightness": 80, "on": true}

# 风机控制
device/{vid}/control/fan
payload: {"speed": 800, "direction": "in"}

# 全局控制
device/{vid}/control/global
payload: {"TinDH": 25.0, "TinDL": 5.0, "TG": 2.0}

# 报警确认
device/{vid}/control/alarm/ack
payload: {"alarm_id": "ALM001"}
```



### 3. 本地移动装置通信主题

```
# 本地数据推送（给移动巡检设备）
local/{vid}/data
payload: {"Tin": 22.5, "LXin": 300, "VStatus": 0}

# 本地报警通知
local/{vid}/alarm
payload: {"type": "故障", "message": "设备故障"}

# 移动装置连接通知
local/{vid}/mobile/connected
payload: {"device_id": "MOBILE001"}
```



### 4. 服务器状态主题

```
# 服务器心跳
server/heartbeat
payload: {"timestamp": 1620000000, "status": "running"}

# 连接状态
device/{vid}/connection
payload: {"connected": true, "last_seen": 1620000000}
```


## 三、接口规格说明

### 1. 数据格式

- 所有JSON数据使用UTF-8编码
- 时间戳使用Unix时间戳（秒）
- 温度单位：摄氏度
- 光照单位：lux

### 2. 通信频率

- 硬件数据上报：≤1秒（满足<2秒要求）
- 服务器数据推送：≤5秒（满足<10秒要求）
- 心跳包：30秒一次
- 报警即时推送

### 3. QoS等级

```
MQTT QoS设置：
- 报警数据：QoS 2（确保送达）
- 控制指令：QoS 1（至少一次）
- 普通数据：QoS 0（最多一次）
```



### 4. 错误处理

```
HTTP状态码：
- 200: 成功
- 400: 请求参数错误
- 404: 设备不存在
- 500: 服务器错误

MQTT错误处理：
- 重连机制：指数退避
- 离线消息：保留最后一条
- 会话持久化：启用
```



## 四、安全考虑

1. **认证机制**

   - HTTP API：JWT令牌认证
   - MQTT：用户名/密码认证
   - 设备证书：每个设备独立证书

2. **权限控制**

   ```
   角色：
   - 管理员：所有操作权限
   - 操作员：查看+控制权限
   - 观察员：只读权限
   ```

3. **数据加密**

   - HTTP：HTTPS加密
   - MQTT：TLS/SSL加密

这个设计方案可以满足竞赛要求的所有功能，包括实时监控、历史查询、远程控制、本地移动装置通信等，同时考虑了性能和安全性。